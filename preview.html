<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TEAM RAIDEN 推しプロフィール</title>

  <!-- Chart.js + DataLabels + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

  <style>
    /* 画像の比率に合わせ、768px × 1223px の固定サイズ */
    body {
      margin: 0; padding: 0;
      background: #eee; /* 背景お好み */
      font-family: "Segoe UI", sans-serif;
      color: #333;
    }

    /* .profile-page: 幅768px, 高さ1223pxを固定し、中央寄せ */
    .profile-page {
      width: 768px;
      height: 1223px;
      margin: 20px auto;
      background: #fff; 
      position: relative;
      overflow: hidden; 
      box-sizing: border-box;
      border: 2px solid #FFD700;
      border-radius: 10px;
    }

    /* タイトル */
    h1 {
      text-align: center;
      margin: 10px 0;
      color: #FFC200;
      font-size: 1.6rem;
      font-weight: bold;
      text-shadow: 1px 1px 2px #333;
    }

    /* プレビュー枠 (html2canvas対象) */
    .preview-container {
      width: 100%;
      height: 100%;
      position: relative;
      box-sizing: border-box;
      overflow: hidden;
      border: 2px dashed #FFDD58;
      margin: 0 auto;
      border-radius: 10px;
      background: #fff;
    }

    #previewContainer {
      width: 100%;
      height: 100%;
      position: relative;
      padding: 20px;   /* 内側余白 */
      box-sizing: border-box;
    }

    /* 上段2カラム: 推し情報 + 性格チャート(ifトーク) */
    .top-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 16px;
    }
    .left-box, .right-box {
      flex: 1 1 350px;
      min-width: 300px;
      background: #FFFDE7;
      border-radius: 8px;
      padding: 10px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    /* 推し写真 */
    #photoImg {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border: 2px solid #FFC200;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #fff;
      display: block;
    }

    p { margin: 5px 0; font-size: 0.9rem; color: #333; }
    b { color: #000; font-weight: bold; }

    /* 質問回答で文字数超過を隠す */
    .answer-line {
      width: 100%;
      height: 20px;
      overflow: hidden;
      white-space: nowrap;
    }
    .answer-line-big {
      width: 100%;
      height: 40px;
      overflow: hidden;
    }

    /* 性格チャート */
    .chart-container {
      width: 100%;
      max-width: 240px;
      margin: 0 auto 10px;
    }

    /* ベストメモリーズ */
    .best-memories-box {
      background: #FFFDE7;
      border-radius: 8px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.1);
      padding: 10px;
      margin-bottom: 16px;
    }

    /* 家系図: ベストメモリーズの下 */
    .family-tree-box {
      background: #FFFDE7;
      border: 2px dashed #FFC200;
      border-radius: 8px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.1);
      width: 100%;
      height: 320px; /* 画像比率に合わせて高さ適宜 */
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
    }
    .family-node {
      position: absolute;
      width: 80px;
      height: 100px;
      text-align: center;
      border: 2px solid #FFC200;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      z-index: 1;
    }
    .family-node .family-img {
      width: 100%;
      height: 60px;
      object-fit: cover;
      border-bottom: 2px solid #FFC200;
      background: #eee;
    }
    .family-node .label {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #333;
      font-weight: bold;
    }

    /* 例: 座標をコンパクトに配置 */
    #fatherNode   { left:40px; top:20px; }
    #motherNode   { left:200px; top:20px; }
    #brotherNode  { left:10px; top:150px; }
    #sisterNode   { left:100px; top:150px; }
    #yBrotherNode { left:190px; top:150px; }
    #ySisterNode  { left:280px; top:150px; }
    #petNode      { left:140px; top:230px; }

    /* 線(div) */
    .tree-line {
      position: absolute;
      background: #FFC200;
      z-index: 0;
    }
    /* 適宜調整 */
    #lineFatherMother {
      left:80px; top:45px; width:120px; height:4px;
    }
    #lineDownFromParents {
      left:140px; top:45px; width:4px; height:40px;
    }
    #lineChildren {
      left:10px; top:85px; width:270px; height:4px;
    }
    #lineToBrother {
      left:50px; top:85px; width:4px; height:65px;
    }
    #lineToSister {
      left:140px; top:85px; width:4px; height:65px;
    }
    #lineToYBrother {
      left:230px; top:85px; width:4px; height:65px;
    }
    #lineToYSister {
      left:320px; top:85px; width:4px; height:65px;
    }
    #lineToPet {
      left:140px; top:150px; width:4px; height:80px;
    }

    /* 推しへのメッセージ: 1番下に端から端まで */
    .message-box {
      background: #FFFDE7;
      border-radius: 8px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.1);
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      min-height: 60px;
    }

    /* ボタン */
    .share-buttons {
      text-align: center;
      margin-top: 10px;
    }
    .share-buttons button {
      background-color: #FFC200;
      border: none;
      border-radius: 30px;
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      padding: 10px 20px;
      cursor: pointer;
      margin: 0 8px;
    }
    .share-buttons button:hover {
      background: #ffe366;
    }

    /* 参考: 印刷には比率変わる可能性→デザインは画像用 */
  </style>
</head>
<body>
  <div class="profile-page">
    <h1>TEAM RAIDEN 推しプロフィール</h1>

    <!-- previewContainerを含むラッパ -->
    <div class="preview-container">
      <div id="previewContainer">
        <!-- ▼ 上段(2カラム) -->
        <div class="top-section">
          <!-- 左カラム: 推し写真 / 推し選手 / 呼び方 / 好きなところ / きっかけ / ここを知って -->
          <div class="left-box">
            <h2>推し情報</h2>
            <img id="photoImg" src="" alt="推し写真">
            <p><b>推し選手:</b> <span class="answer-line" id="playerDisplay"></span></p>
            <p><b>呼び方:</b> <span class="answer-line" id="nicknameDisplay"></span></p>
            <p><b>好きなところ:</b> <span class="answer-line" id="favoriteThingDisplay"></span></p>
            <p><b>きっかけ:</b> <span class="answer-line" id="fanReasonDisplay"></span></p>
            <p><b>ここを知って:</b> <span class="answer-line" id="highlightDisplay"></span></p>
          </div>

          <!-- 右カラム: 性格チャート / ifトーク -->
          <div class="right-box">
            <h2>性格チャート</h2>
            <div class="chart-container">
              <canvas id="myChart"></canvas>
            </div>

            <h2>ifトーク</h2>
            <p><b>学校の先生:</b> <span class="answer-line" id="teacherDisplay"></span></p>
            <p><b>無人島:</b> <span class="answer-line" id="islandDisplay"></span></p>
            <p><b>上司:</b> <span class="answer-line" id="bossDisplay"></span></p>
            <p><b>後輩:</b> <span class="answer-line" id="juniorDisplay"></span></p>
          </div>
        </div><!-- /top-section -->

        <!-- ▼ ベストメモリーズ -->
        <div class="best-memories-box">
          <h2>ベストメモリーズ</h2>
          <p><b>一番の思い出:</b>  
            <span class="answer-line-big" id="memory1Display"></span>
          </p>
          <p><b>輝いた時:</b>  
            <span class="answer-line-big" id="memory2Display"></span>
          </p>
        </div>

        <!-- ▼ 家系図: ベストメモリーズの下 -->
        <h2>家族に例えるなら (トーナメント家系図)</h2>
        <div class="family-tree-box" id="familyTreeWrapper">
          <!-- 父 -->
          <div class="family-node" id="fatherNode">
            <img id="fatherPhoto" class="family-img" alt="父">
            <div class="label" id="fatherLabel"></div>
          </div>
          <!-- 母 -->
          <div class="family-node" id="motherNode">
            <img id="motherPhoto" class="family-img" alt="母">
            <div class="label" id="motherLabel"></div>
          </div>
          <!-- 兄 -->
          <div class="family-node" id="brotherNode">
            <img id="brotherPhoto" class="family-img" alt="兄">
            <div class="label" id="brotherLabel"></div>
          </div>
          <!-- 姉 -->
          <div class="family-node" id="sisterNode">
            <img id="sisterPhoto" class="family-img" alt="姉">
            <div class="label" id="sisterLabel"></div>
          </div>
          <!-- 弟 -->
          <div class="family-node" id="yBrotherNode">
            <img id="yBrotherPhoto" class="family-img" alt="弟">
            <div class="label" id="yBrotherLabel"></div>
          </div>
          <!-- 妹 -->
          <div class="family-node" id="ySisterNode">
            <img id="ySisterPhoto" class="family-img" alt="妹">
            <div class="label" id="ySisterLabel"></div>
          </div>
          <!-- ペット -->
          <div class="family-node" id="petNode">
            <img id="petPhoto" class="family-img" alt="ペット">
            <div class="label" id="petLabel"></div>
          </div>

          <!-- 線(div) -->
          <div class="tree-line" id="lineFatherMother"></div>
          <div class="tree-line" id="lineDownFromParents"></div>
          <div class="tree-line" id="lineChildren"></div>
          <div class="tree-line" id="lineToBrother"></div>
          <div class="tree-line" id="lineToSister"></div>
          <div class="tree-line" id="lineToYBrother"></div>
          <div class="tree-line" id="lineToYSister"></div>
          <div class="tree-line" id="lineToPet"></div>
        </div>

        <!-- ▼ 推しへのメッセージ: 最下部・端から端 -->
        <h2 style="margin-top:16px;">推しへのメッセージ</h2>
        <div class="message-box">
          <span class="answer-line-big" id="messageDisplay"></span>
        </div>
      </div><!-- /#previewContainer -->
    </div><!-- /.preview-container -->

    <!-- ▼ 画面下部ボタン (シェアボタン含む) -->
    <div class="share-buttons">
      <button id="editBtn">修正する</button>
      <button id="shareStep1Btn">シェア準備</button>
    </div>
  </div><!-- /.profile-page -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataStr = localStorage.getItem('raidenProfileData');
      if(!dataStr){
        document.body.insertAdjacentHTML('beforeend','<p>データがありません</p>');
        return;
      }
      const data = JSON.parse(dataStr);

      // 文字数制限で切り捨て
      function truncate(str, maxLen){
        if(!str) return "";
        return str.substring(0, maxLen);
      }
      // 項目別
      const playerName     = truncate(data.playerSelect,   20);
      const nickname       = truncate(data.nickname,       10);
      const favoriteThing  = truncate(data.favoriteThing,  13);
      const fanReason      = truncate(data.fanReason,      18);
      const highlight      = truncate(data.highlight,      12);
      const memory1        = truncate(data.memory1,        72);
      const memory2        = truncate(data.memory2,        72);
      const teacher        = truncate(data.teacher,        20);
      const island         = truncate(data.island,         20);
      const boss           = truncate(data.boss,           20);
      const junior         = truncate(data.junior,         20);
      const message        = truncate(data.message,       148);

      // 推し写真
      document.getElementById('photoImg').src = data.photoDataURL || "";

      // テキスト
      document.getElementById('playerDisplay').textContent    = playerName;
      document.getElementById('nicknameDisplay').textContent  = nickname;
      document.getElementById('favoriteThingDisplay').textContent = favoriteThing;
      document.getElementById('fanReasonDisplay').textContent = fanReason;
      document.getElementById('highlightDisplay').textContent = highlight;
      document.getElementById('memory1Display').textContent   = memory1;
      document.getElementById('memory2Display').textContent   = memory2;
      document.getElementById('teacherDisplay').textContent   = teacher;
      document.getElementById('islandDisplay').textContent    = island;
      document.getElementById('bossDisplay').textContent      = boss;
      document.getElementById('juniorDisplay').textContent    = junior;
      document.getElementById('messageDisplay').textContent   = message;

      // 家系図 (選手名→写真)
      const photoMap = {
        "萩原聖人":   "images/hagiwara.jpg",
        "瀬戸熊直樹": "images/setokuma.jpg",
        "黒沢咲":     "images/kurosawa.jpg",
        "本田朋広":   "images/honda.jpg"
      };
      const noImg = "images/noimage.png";
      function getImg(n){ return photoMap[n] || noImg; }
      document.getElementById('fatherLabel').textContent  = data.father || "";
      document.getElementById('motherLabel').textContent  = data.mother || "";
      document.getElementById('brotherLabel').textContent = data.brother || "";
      document.getElementById('sisterLabel').textContent  = data.sister || "";
      document.getElementById('yBrotherLabel').textContent= data.youngerBrother || "";
      document.getElementById('ySisterLabel').textContent = data.youngerSister || "";
      document.getElementById('petLabel').textContent     = data.pet || "";

      document.getElementById('fatherPhoto').src   = getImg(data.father);
      document.getElementById('motherPhoto').src   = getImg(data.mother);
      document.getElementById('brotherPhoto').src  = getImg(data.brother);
      document.getElementById('sisterPhoto').src   = getImg(data.sister);
      document.getElementById('yBrotherPhoto').src = getImg(data.youngerBrother);
      document.getElementById('ySisterPhoto').src  = getImg(data.youngerSister);
      document.getElementById('petPhoto').src      = getImg(data.pet);

      // 円グラフ(クール=青, かわいい=ピンク, 優しい=緑, 面白い=黄, 強い=赤)
      const c  = parseFloat(data.cool)   || 0;
      const cu = parseFloat(data.cute)   || 0;
      const k  = parseFloat(data.kind)   || 0;
      const f  = parseFloat(data.funny)  || 0;
      const s  = parseFloat(data.strong) || 0;
      const sum = c + cu + k + f + s;
      let ratioData = [0, 0, 0, 0, 0];
      if(sum>0){
        ratioData = [c/sum, cu/sum, k/sum, f/sum, s/sum];
      }
      const bgColors = ["#377eb8","#ff69b4","#4daf4a","#ffeb3b","#e41a1c"];

      new Chart(document.getElementById('myChart').getContext('2d'), {
        type: 'pie',
        data: {
          labels: ["クール","かわいい","優しい","面白い","強い"],
          datasets: [{
            data: ratioData,
            backgroundColor: bgColors
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const lbl = ctx.label || "";
                  const val = (ctx.parsed*100).toFixed(0) + "%";
                  return lbl + ": " + val;
                }
              }
            },
            legend: {
              labels: { color: "#333", font: { size:14 } }
            },
            datalabels: {
              color: "#fff",
              formatter: (val) => (val*100).toFixed(0)+"%"
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // ボタン
      document.getElementById('editBtn').addEventListener('click', () => {
        // 修正する -> index.htmlへ
        window.location.href = "index.html";
      });
      document.getElementById('shareStep1Btn').addEventListener('click', async () => {
        // シェア準備 -> html2canvasでキャプチャ -> localStorageに dataURL保存 -> loadingShare.html
        const container = document.getElementById('previewContainer');
        const canvas = await html2canvas(container);
        const dataUrl = canvas.toDataURL("image/png");
        localStorage.setItem('shareImage', dataUrl);
        window.location.href = "loadingShare.html";
      });
    });
  </script>
</body>
</html>
