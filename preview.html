<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TEAM RAIDEN 推しプロフィール</title>
  
  <!-- Chart.js + DataLabels + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

  <style>
    /* 背景を黒～金系のグラデーションに */
    body {
      margin: 0; padding: 0;
      background: linear-gradient(180deg, #111 10%, #FFC200 200%);
      font-family: "Segoe UI", sans-serif;
      color: #333;
    }
    main {
      width: 800px; /* X共有しやすいよう適度に幅を狭める */
      margin: 30px auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      padding: 20px 30px;
      position: relative;
      overflow: hidden;
    }
    /* タイトルから「- プレビュー」を除外 */
    h1 {
      text-align: center;
      margin: 10px 0 20px;
      color: #FFC200; /* 金色 */
      font-weight: bold;
      font-size: 1.8rem;
      text-shadow: 1px 1px 2px #333;
    }

    /* ポップな吹き出し風タイトルデザイン */
    h2 {
      display: inline-block;
      background: #FFC200;
      color: #000;
      padding: 6px 14px;
      border-radius: 20px;
      margin: 1.2em 0 0.5em;
      font-size: 1rem;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.2);
      position: relative;
    }
    h2::after {
      content: "";
      position: absolute;
      left: 10px;
      top: 100%;
      width: 0; 
      height: 0; 
      border: 10px solid transparent;
      border-top-color: #FFC200; 
    }

    /* プレビューボックスの大枠デザイン */
    .preview-container {
      background: #fff;
      border: 3px dashed #FFC200;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }
    /* 内側のコンテンツ用 */
    #previewContainer {
      background: #fff;
      border: 2px dashed #FFDD58; 
      border-radius: 16px;
      padding: 20px;
      margin: 0 auto;
      position: relative;
      box-sizing: border-box;
    }

    /* 左右に振り分ける部分 */
    #profileHeader {
      display: flex;
      flex-wrap: wrap; /* 画面が狭いとき折り返し */
      gap: 20px;
    }
    .left-box, .right-box {
      flex: 1 1 300px; /* 最低幅確保しつつ伸縮 */
      min-width: 260px;
      background: #FFFDE7;
      border-radius: 12px;
      padding: 10px 15px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .left-box h2,
    .right-box h2 {
      margin-top: 0.2em; 
    }
    /* 推し写真 */
    #photoImg {
      display: block;
      max-width: 180px;
      max-height: 180px;
      border-radius: 10px;
      border: 2px solid #FFC200;
      margin-bottom: 10px;
      background: #fff;
      object-fit: cover;
    }
    p {
      margin: 6px 0; 
      font-size: 0.9rem;
      color: #333;
    }
    b {
      color: #000;
      font-weight: bold;
    }

    /* chart, ifトーク, メッセージ まとめた右ボックス内 */
    .chart-container {
      width: 100%;
      max-width: 280px;
      margin: 0 auto 10px;
    }

    /* 家系図 */
    h2.family-title {
      text-align:center;
      margin-top: 40px;
    }
    #familyTreeWrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      height: 460px; /* ちょっと小さめに */
      margin: 20px auto;
      background: #FFFDE7;
      border: 2px dashed #FFC200;
      border-radius: 12px;
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.08);
      box-sizing: border-box;
    }
    .family-node {
      position: absolute;
      width: 80px;
      height: 100px;
      text-align: center;
      border: 2px solid #FFC200;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      z-index: 1; /* 線より前面に */
    }
    .family-node .family-img {
      width: 100%;
      height: 60px;
      object-fit: cover;
      border-bottom: 2px solid #FFC200;
      background:#eee;
    }
    .family-node .label {
      margin-top: 5px;
      font-size: 0.7rem;
      color: #333;
      font-weight: bold;
    }
    /* 位置調整(線と被らないよう少しズラす) */
    #fatherNode { left: 60px; top: 20px; }
    #motherNode { left: 360px; top: 20px; }
    #brotherNode { left: 10px; top: 220px; }
    #sisterNode { left: 130px; top: 220px; }
    #yBrotherNode { left: 250px; top: 220px; }
    #ySisterNode { left: 370px; top: 220px; }
    #petNode { left: 200px; top: 340px; }

    /* 線: z-index:0 で写真と重ならない */
    .tree-line {
      position: absolute;
      background: #FFC200;
      z-index: 0;
    }
    #lineFatherMother {
      left: 140px; top: 50px;
      width: 220px; height: 4px;
    }
    #lineDownFromParents {
      left: 250px; top: 50px;
      width: 4px; height: 60px;
    }
    #lineChildren {
      left: 10px; top: 110px;
      width: 430px; height: 4px;
    }
    #lineToBrother {
      left: 50px; top: 110px;
      width: 4px; height: 110px;
    }
    #lineToSister {
      left: 170px; top: 110px;
      width: 4px; height: 110px;
    }
    #lineToYBrother {
      left: 290px; top: 110px;
      width: 4px; height: 110px;
    }
    #lineToYSister {
      left: 410px; top: 110px;
      width: 4px; height: 110px;
    }
    #lineToPet {
      left: 250px; top: 220px;
      width: 4px; height: 120px;
    }

    /* ボタン */
    .share-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .share-buttons button {
      background-color: #FFC200;
      border: none;
      border-radius: 30px;   /* 角を丸く */
      color: #000;
      font-weight: bold;
      font-size: 1.2rem;     /* 文字大きめ */
      padding: 14px 40px;    /* ボタンを大きく */
      cursor: pointer;
      transition: background 0.2s;
      margin: 0 10px;
    }
    .share-buttons button:hover {
      background: #ffdb4b;
    }
  </style>
</head>
<body>
  <main>
    <!-- タイトルは「TEAM RAIDEN 推しプロフィール」だけに -->
    <h1>TEAM RAIDEN 推しプロフィール</h1>

    <div class="preview-container">
      <div id="previewContainer">
        <!-- ▼ 上段: 推し情報 + 性格チャート/etc. -->
        <div id="profileHeader">
          <!-- 左カラム -->
          <div class="left-box">
            <h2>推し情報</h2>
            <img id="photoImg" src="" alt="推し写真">
            <p><b>推し選手:</b> <span id="playerDisplay"></span></p>
            <p><b>呼び方:</b> <span id="nicknameDisplay"></span></p>
            <p><b>好きなところ:</b> <span id="favoriteThingDisplay"></span></p>
            <p><b>きっかけ:</b> <span id="fanReasonDisplay"></span></p>
            <p><b>ここを知って:</b> <span id="highlightDisplay"></span></p>

            <h2>ベストメモリーズ</h2>
            <p><b>一番の思い出:</b> <span id="memory1Display"></span></p>
            <p><b>輝いた時:</b> <span id="memory2Display"></span></p>
          </div>

          <!-- 右カラム -->
          <div class="right-box">
            <h2>性格チャート</h2>
            <div class="chart-container">
              <canvas id="myChart"></canvas>
            </div>
            <h2>ifトーク</h2>
            <p><b>学校の先生:</b> <span id="teacherDisplay"></span></p>
            <p><b>無人島:</b> <span id="islandDisplay"></span></p>
            <p><b>上司:</b> <span id="bossDisplay"></span></p>
            <p><b>後輩:</b> <span id="juniorDisplay"></span></p>

            <h2>推しへのメッセージ</h2>
            <p id="messageDisplay"></p>
          </div>
        </div><!-- /#profileHeader -->

        <!-- ▼ 家系図 (トーナメント表風) -->
        <h2 class="family-title">家族に例えるなら (トーナメント家系図)</h2>
        <div id="familyTreeWrapper">
          <!-- 父 -->
          <div class="family-node" id="fatherNode">
            <img id="fatherPhoto" class="family-img" alt="父">
            <div class="label" id="fatherLabel"></div>
          </div>
          <!-- 母 -->
          <div class="family-node" id="motherNode">
            <img id="motherPhoto" class="family-img" alt="母">
            <div class="label" id="motherLabel"></div>
          </div>
          <!-- 兄 -->
          <div class="family-node" id="brotherNode">
            <img id="brotherPhoto" class="family-img" alt="兄">
            <div class="label" id="brotherLabel"></div>
          </div>
          <!-- 姉 -->
          <div class="family-node" id="sisterNode">
            <img id="sisterPhoto" class="family-img" alt="姉">
            <div class="label" id="sisterLabel"></div>
          </div>
          <!-- 弟 -->
          <div class="family-node" id="yBrotherNode">
            <img id="yBrotherPhoto" class="family-img" alt="弟">
            <div class="label" id="yBrotherLabel"></div>
          </div>
          <!-- 妹 -->
          <div class="family-node" id="ySisterNode">
            <img id="ySisterPhoto" class="family-img" alt="妹">
            <div class="label" id="ySisterLabel"></div>
          </div>
          <!-- ペット -->
          <div class="family-node" id="petNode">
            <img id="petPhoto" class="family-img" alt="ペット">
            <div class="label" id="petLabel"></div>
          </div>

          <!-- 線(div) -->
          <div class="tree-line" id="lineFatherMother"></div>
          <div class="tree-line" id="lineDownFromParents"></div>
          <div class="tree-line" id="lineChildren"></div>
          <div class="tree-line" id="lineToBrother"></div>
          <div class="tree-line" id="lineToSister"></div>
          <div class="tree-line" id="lineToYBrother"></div>
          <div class="tree-line" id="lineToYSister"></div>
          <div class="tree-line" id="lineToPet"></div>
        </div>
      </div><!-- #previewContainer -->
    </div><!-- .preview-container -->

    <div class="share-buttons">
      <button id="editBtn">修正する</button>
      <button id="shareStep1Btn">シェア準備</button>
    </div>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const dataStr = localStorage.getItem('raidenProfileData');
      if(!dataStr){
        document.body.insertAdjacentHTML('beforeend','<p>データがありません</p>');
        return;
      }
      const data = JSON.parse(dataStr);

      // 画像(推し選手)
      if(data.photoDataURL){
        id('photoImg').src = data.photoDataURL;
      }

      // テキスト(推し情報など)
      id('playerDisplay').textContent    = data.playerSelect    || "";
      id('nicknameDisplay').textContent  = data.nickname        || "";
      id('favoriteThingDisplay').textContent = data.favoriteThing || "";
      id('fanReasonDisplay').textContent = data.fanReason       || "";
      id('highlightDisplay').textContent = data.highlight       || "";
      id('memory1Display').textContent   = data.memory1         || "";
      id('memory2Display').textContent   = data.memory2         || "";
      id('teacherDisplay').textContent   = data.teacher         || "";
      id('islandDisplay').textContent    = data.island          || "";
      id('bossDisplay').textContent      = data.boss            || "";
      id('juniorDisplay').textContent    = data.junior          || "";
      id('messageDisplay').textContent   = data.message         || "";

      // 家系図 (選手名 → 写真)
      const photoMap = {
        "萩原聖人"   : "images/hagiwara.jpg",
        "瀬戸熊直樹" : "images/setokuma.jpg",
        "黒沢咲"     : "images/kurosawa.jpg",
        "本田朋広"   : "images/honda.jpg"
      };
      const noImg = "images/noimage.png";
      function getImg(name){
        return photoMap[name] || noImg;
      }
      id('fatherLabel').textContent   = data.father         || "";
      id('fatherPhoto').src          = getImg(data.father);
      id('motherLabel').textContent  = data.mother         || "";
      id('motherPhoto').src          = getImg(data.mother);
      id('brotherLabel').textContent = data.brother        || "";
      id('brotherPhoto').src         = getImg(data.brother);
      id('sisterLabel').textContent  = data.sister         || "";
      id('sisterPhoto').src          = getImg(data.sister);
      id('yBrotherLabel').textContent= data.youngerBrother || "";
      id('yBrotherPhoto').src        = getImg(data.youngerBrother);
      id('ySisterLabel').textContent = data.youngerSister  || "";
      id('ySisterPhoto').src         = getImg(data.youngerSister);
      id('petLabel').textContent     = data.pet            || "";
      id('petPhoto').src             = getImg(data.pet);

      // 性格チャートの色分けを、はっきりした色に変更
      const chartColors = [
        "#e41a1c", /* 赤 */
        "#377eb8", /* 青 */
        "#4daf4a", /* 緑 */
        "#984ea3", /* 紫 */
        "#ff7f00"  /* オレンジ */
      ];
      const c  = parseFloat(data.cool)   || 0,
            cu = parseFloat(data.cute)   || 0,
            k  = parseFloat(data.kind)   || 0,
            f  = parseFloat(data.funny)  || 0,
            s  = parseFloat(data.strong) || 0;
      const sum = c + cu + k + f + s;
      let ratioData = [0, 0, 0, 0, 0];
      if(sum > 0){
        ratioData = [ c/sum, cu/sum, k/sum, f/sum, s/sum ];
      }

      new Chart(id('myChart').getContext('2d'), {
        type: 'pie',
        data: {
          labels: ["クール","かわいい","優しい","面白い","強い"],
          datasets: [{
            data: ratioData,
            backgroundColor: chartColors
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const lbl = ctx.label || "";
                  const val = (ctx.parsed * 100).toFixed(0) + "%";
                  return lbl + ": " + val;
                }
              }
            },
            legend: {
              labels: {
                color: "#333",
                font: { size: 14 }
              }
            },
            datalabels: {
              color: "#fff", /* グラフ上の数値表示は白字に */
              formatter: (value) => (value * 100).toFixed(0) + "%"
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // ボタン
      id('editBtn').addEventListener('click', () => {
        window.location.href = "index.html";
      });
      id('shareStep1Btn').addEventListener('click', async () => {
        const container = id('previewContainer');
        const canvas = await html2canvas(container);
        const dataUrl = canvas.toDataURL("image/png");
        localStorage.setItem('shareImage', dataUrl);
        window.location.href = "loadingShare.html";
      });

      function id(x){ return document.getElementById(x); }
    });
  </script>
</body>
</html>
