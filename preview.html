<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TEAM RAIDEN - プレビュー</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
</head>
<body>
  <main>
    <h1>TEAM RAIDEN プレビュー (1回目ボタン)</h1>
    <div class="preview-container">
      <div id="previewContainer">
        <!-- 横幅1200,高さ675 → ここに推し写真/情報/チャート配置 -->
        <div style="padding:10px;">
          <img id="photoImg" class="raiden-photo" src="" alt="">
          <p><b>推し選手:</b> <span id="playerDisplay"></span></p>
          <p><b>呼び方:</b> <span id="nicknameDisplay"></span></p>
          <!-- etc... -->
          <div class="chart-container">
            <canvas id="myChart"></canvas>
          </div>
          <p id="messageDisplay"></p>
        </div>
      </div>
    </div>

    <div class="share-buttons">
      <button id="editBtn">修正する</button>
      <button id="shareStep1Btn">シェア準備</button>
    </div>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded',async()=>{
      const dataStr= localStorage.getItem('raidenProfileData');
      if(!dataStr){
        document.body.insertAdjacentHTML('beforeend','<p>データがありません</p>');
        return;
      }
      const data= JSON.parse(dataStr);

      // 写真
      const photoImg= document.getElementById('photoImg');
      if(data.photoDataURL) photoImg.src= data.photoDataURL;

      // テキスト
      document.getElementById('playerDisplay').textContent= data.playerSelect||"";
      document.getElementById('nicknameDisplay').textContent= data.nickname||"";
      document.getElementById('messageDisplay').textContent= data.message||"";

      // 性格チャート: 各値
      const cool= parseFloat(data.cool)||0, cute= parseFloat(data.cute)||0,
            kind= parseFloat(data.kind)||0, funny= parseFloat(data.funny)||0, strong= parseFloat(data.strong)||0;
      const sum= cool+ cute+ kind+ funny+ strong;
      let ratioData= [0,0,0,0,0];
      if(sum>0){
        ratioData=[cool/sum,cute/sum,kind/sum,funny/sum,strong/sum];
      }
      const ctx= document.getElementById('myChart').getContext('2d');
      new Chart(ctx,{
        type:'pie',
        data:{
          labels:["クール","かわいい","優しい","面白い","強い"],
          datasets:[{
            data: ratioData,
            backgroundColor:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"]
          }]
        },
        options:{
          plugins:{
            tooltip:{
              callbacks:{
                label: function(context){
                  const lbl= context.label || "";
                  // valueは ratio(0~1)→xx%
                  const v= context.parsed*100;
                  return lbl + ": " + v.toFixed(0)+"%";
                }
              }
            },
            legend:{ labels:{ color:"#333", font:{size:14}}}
          }
        }
      });

      document.getElementById('editBtn').addEventListener('click',()=>{
        window.location.href="index.html";
      });

      // 「シェア準備」ボタン
      document.getElementById('shareStep1Btn').addEventListener('click', async ()=>{
        // html2canvas→ localStorage.setItem('shareImage', base64)
        const container= document.getElementById('previewContainer');
        const canvas= await html2canvas(container);
        const dataUrl= canvas.toDataURL("image/png");
        localStorage.setItem('shareImage', dataUrl);

        // 次へ
        window.location.href= "loadingShare.html";
      });
    });
  </script>
</body>
</html>
