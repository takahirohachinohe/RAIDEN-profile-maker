<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TEAM RAIDEN 推しプロフ - プレビュー</title>
  <link rel="stylesheet" href="style.css">
  <!-- Chart.js (性格チャート) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas (画像化用) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
</head>
<body>
  <header>
    <h1>TEAM RAIDEN 推しプロフ - プレビュー</h1>
  </header>

  <main>
    <!-- ▼ プレビュー領域: #previewContainer -->
    <div id="previewContainer" class="preview-container">
      <h2>推し選手＆基本情報</h2>
      <div id="photoArea"></div>
      <p id="playerSelectDisplay"></p>
      <p id="favoriteThingDisplay"></p>
      <p id="fanReasonDisplay"></p>
      <p id="highlightDisplay"></p>
      <p id="nicknameDisplay"></p>

      <h2>性格チャート(円グラフ)</h2>
      <div class="chart-container">
        <canvas id="myChart"></canvas>
      </div>

      <h2>推しのベストメモリーズ</h2>
      <p id="memory1Display"></p>
      <p id="memory2Display"></p>

      <h2>ifトーク</h2>
      <p id="teacherDisplay"></p>
      <p id="islandDisplay"></p>
      <p id="bossDisplay"></p>
      <p id="juniorDisplay"></p>

      <h2>チームを家族に例えるなら</h2>
      <p id="fatherDisplay"></p>
      <p id="motherDisplay"></p>
      <p id="brotherDisplay"></p>
      <p id="sisterDisplay"></p>
      <p id="youngerBrotherDisplay"></p>
      <p id="youngerSisterDisplay"></p>
      <p id="petDisplay"></p>

      <h2>推しへのメッセージ</h2>
      <p id="messageDisplay"></p>
    </div>

    <!-- ▼ ボタン群 ▼ -->
    <div style="text-align:center; margin-top:20px;">
      <!-- 修正する -->
      <button id="editBtn" style="background:#005f9e; color:#fff; margin-right:10px;">
        修正する
      </button>
      <!-- 画像のみ -->
      <button id="downloadImgBtn" style="background:#555; color:#fff; margin-right:10px;">
        画像のみ
      </button>
      <!-- Xでシェア -->
      <button id="shareXBtn" style="background:#000; color:#fff;">
        Xでシェア
      </button>
    </div>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', async ()=>{
      const dataStr= localStorage.getItem('raidenProfileData');
      if(!dataStr){
        document.body.insertAdjacentHTML('beforeend','<p>データがありません</p>');
        return;
      }
      const data= JSON.parse(dataStr);

      // 1) 画像表示
      const photoDiv= document.getElementById('photoArea');
      if(data.photoDataURL){
        const img= document.createElement('img');
        img.src= data.photoDataURL;
        img.className= "raiden-photo";
        photoDiv.appendChild(img);
      } else {
        photoDiv.textContent= "画像なし or 破棄";
      }

      // 2) テキスト項目
      document.getElementById('playerSelectDisplay').textContent
        = "推し選手: " + (data.playerSelect||'');
      document.getElementById('favoriteThingDisplay').textContent
        = "推しの好きなところ: " + (data.favoriteThing||'');
      document.getElementById('fanReasonDisplay').textContent
        = "推しの好きになったきっかけ: " + (data.fanReason||'');
      document.getElementById('highlightDisplay').textContent
        = "推しのここを知ってほしい: " + (data.highlight||'');
      document.getElementById('nicknameDisplay').textContent
        = "呼び方: " + (data.nickname||'');

      // 性格チャート
      const cool=data.cool||0, cute=data.cute||0, kind=data.kind||0, funny=data.funny||0, strong=data.strong||0;
      const sum = cool + cute + kind + funny + strong;
      let rCool=0,rCute=0,rKind=0,rFunny=0,rStrong=0;
      if(sum>0){
        rCool= cool/sum;
        rCute= cute/sum;
        rKind= kind/sum;
        rFunny= funny/sum;
        rStrong= strong/sum;
      }
      const ctx= document.getElementById('myChart').getContext('2d');
      new Chart(ctx,{
        type:'pie',
        data:{
          labels:['クール','かわいい','優しい','面白い','強い'],
          datasets:[{
            data:[rCool,rCute,rKind,rFunny,rStrong],
            backgroundColor:['#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854']
          }]
        },
        options:{
          plugins:{
            legend:{
              labels:{
                color:'#FFD700',
                font:{size:14}
              }
            }
          }
        }
      });

      // ベストメモリーズ
      document.getElementById('memory1Display').textContent
        = "一番の思い出: " + (data.memory1||'');
      document.getElementById('memory2Display').textContent
        = "輝いた時: " + (data.memory2||'');

      // ifトーク
      document.getElementById('teacherDisplay').textContent
        = "学校の先生にするなら: " + (data.teacher||'');
      document.getElementById('islandDisplay').textContent
        = "無人島に行くなら: " + (data.island||'');
      document.getElementById('bossDisplay').textContent
        = "上司にするなら: " + (data.boss||'');
      document.getElementById('juniorDisplay').textContent
        = "後輩にするなら: " + (data.junior||'');

      // 家族に例える
      document.getElementById('fatherDisplay').textContent
        = "父: " + (data.father||'');
      document.getElementById('motherDisplay').textContent
        = "母: " + (data.mother||'');
      document.getElementById('brotherDisplay').textContent
        = "兄: " + (data.brother||'');
      document.getElementById('sisterDisplay').textContent
        = "姉: " + (data.sister||'');
      document.getElementById('youngerBrotherDisplay').textContent
        = "弟: " + (data.youngerBrother||'');
      document.getElementById('youngerSisterDisplay').textContent
        = "妹: " + (data.youngerSister||'');
      document.getElementById('petDisplay').textContent
        = "ペット: " + (data.pet||'');

      // メッセージ
      document.getElementById('messageDisplay').textContent
        = data.message||'';

      // ========= ボタン処理 =========

      // (A) 修正する -> index.html
      document.getElementById('editBtn').addEventListener('click',()=>{
        window.location.href = "index.html";
      });

      // (B) 画像のみ -> html2canvas
      document.getElementById('downloadImgBtn').addEventListener('click', async ()=>{
        const previewElem= document.getElementById('previewContainer');
        const canvas= await html2canvas(previewElem);
        const a= document.createElement('a');
        a.download = "raiden-profile.png";
        a.href= canvas.toDataURL("image/png");
        a.click();
      });

      // (C) Xでシェア (画像を直接 or テキストだけ)
      document.getElementById('shareXBtn').addEventListener('click', async ()=>{
        // 1) プレビュー領域を画像化
        const previewElem = document.getElementById('previewContainer');
        const canvas = await html2canvas(previewElem);
        const dataUrl = canvas.toDataURL("image/png");

        // 2) Web Share API対応チェック
        if(navigator.canShare && navigator.canShare({ files: [] })){
          // DataURL -> Blob
          const blob = dataURLtoBlob(dataUrl);
          const file = new File([blob], "raiden-profile.png", {type:"image/png"});
          try {
            await navigator.share({
              text: "TEAM RAIDEN 推しプロフを作成！",
              files: [file]
            });
          } catch(e){
            console.warn("シェアがキャンセル or 失敗", e);
          }
        } else {
          // Web Share API未対応 → intent/tweet(テキストのみ)
          const text = "TEAM RAIDEN 推しプロフ作成！(画像は手動でアップしてね)";
          const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
          window.open(tweetUrl,"_blank");
        }
      });

      // DataURL->Blob 変換
      function dataURLtoBlob(dataurl){
        const arr = dataurl.split(','), 
              mime = arr[0].match(/:(.*?);/)[1],
              bstr = atob(arr[1]),
              n = bstr.length,
              u8arr = new Uint8Array(n);
        for(let i=0;i<n;i++){
          u8arr[i] = bstr.charCodeAt(i);
        }
        return new Blob([u8arr], {type:mime});
      }
    });
  </script>
</body>
</html>
